name: Deploy FastAPI App to GCP VM

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Source Code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 3. Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 4. Build Docker Image (FastAPI)
        run: |
          echo "==== ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œìž‘ ===="
          docker build -t my-fastapi-app .
          echo "==== ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ ===="

      - name: 5. Setup SSH for GCP VM
        run: |
          echo "==== SSH í‚¤ ì„¤ì • ì‹œìž‘ ===="
          mkdir -p ~/.ssh
          
          # SSH í‚¤ íŒŒì¼ ìƒì„± (ê°œí–‰ë¬¸ìž ì²˜ë¦¬)
          echo "${{ secrets.GCP_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # SSH ì„¤ì • íŒŒì¼ ìƒì„±
          cat >> ~/.ssh/config << EOF
          Host gcp-vm
            HostName 34.47.103.49
            User gwinvade99
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          
          chmod 600 ~/.ssh/config
          
          # SSH í‚¤ í™•ì¸
          echo "SSH í‚¤ íŒŒì¼ ë‚´ìš© í™•ì¸:"
          ls -la ~/.ssh/
          echo "SSH í‚¤ í˜•ì‹ í™•ì¸:"
          ssh-keygen -l -f ~/.ssh/id_ed25519 || echo "SSH í‚¤ í˜•ì‹ì— ë¬¸ì œê°€ ìžˆìŠµë‹ˆë‹¤."
          
          # SSH í‚¤ ë‚´ìš© í™•ì¸ (ì²˜ìŒ ëª‡ ì¤„ë§Œ)
          echo "SSH í‚¤ ë‚´ìš© (ì²˜ìŒ 3ì¤„):"
          head -3 ~/.ssh/id_ed25519
          echo "SSH í‚¤ ë‚´ìš© (ë§ˆì§€ë§‰ 3ì¤„):"
          tail -3 ~/.ssh/id_ed25519
          
          # ê³µê°œí‚¤ ì¶”ì¶œ ì‹œë„
          echo "ê³µê°œí‚¤ ì¶”ì¶œ ì‹œë„:"
          ssh-keygen -y -f ~/.ssh/id_ed25519 || echo "ê³µê°œí‚¤ ì¶”ì¶œ ì‹¤íŒ¨"
          
          echo "==== SSH í‚¤ ì„¤ì • ì™„ë£Œ ===="

      - name: 6. Test SSH Connection
        run: |
          echo "==== SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ===="
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=10 gwinvade99@34.47.103.49 'echo "SSH ì—°ê²° ì„±ê³µ!"' || {
            echo "SSH ì—°ê²° ì‹¤íŒ¨. ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:"
            echo "1. GCP_SSH_KEY secretì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸"
            echo "2. GCP VMì˜ authorized_keysì— ê³µê°œí‚¤ê°€ ë“±ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸"
            echo "3. GCP VMì˜ ë°©í™”ë²½ ì„¤ì • í™•ì¸"
            exit 1
          }

      - name: 7. Check Required Tools on GCP VM
        run: |
          echo "==== GCP VM í•„ìˆ˜ ë„êµ¬ í™•ì¸ ===="
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 gwinvade99@34.47.103.49 '
            echo "rsync ë²„ì „ í™•ì¸:"
            rsync --version || echo "rsyncì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”: sudo apt-get install -y rsync"
            
            echo "Docker ë²„ì „ í™•ì¸:"
            sudo docker --version || echo "Dockerê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            
            echo "í•„ìˆ˜ ë„êµ¬ í™•ì¸ ì™„ë£Œ!"
          '

      - name: 8. Deploy Files to GCP VM
        run: |
          echo "==== GCP VMì— í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ===="
          # ì„œë²„ì˜ ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ìž¬ìƒì„±
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 gwinvade99@34.47.103.49 'rm -rf ~/beneficial-be && mkdir ~/beneficial-be'
          
          # scpë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  í”„ë¡œì íŠ¸ íŒŒì¼ê³¼ ë””ë ‰í† ë¦¬ë¥¼ ìž¬ê·€ì ìœ¼ë¡œ ë³µì‚¬
          scp -r -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 ./* gwinvade99@34.47.103.49:~/beneficial-be/
          echo "íŒŒì¼ ë³µì‚¬ ì™„ë£Œ!"

      - name: 9. Build & Run Docker on GCP VM
        run: |
          echo "==== GCP VMì—ì„œ ë„ì»¤ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰ ===="
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=30 gwinvade99@34.47.103.49 '
            set -e
            cd ~/beneficial-be
            echo "ê¸°ì¡´ fastapi-app ì»¨í…Œì´ë„ˆ ì •ì§€ ë° ì‚­ì œ ì‹œë„..."
            sudo docker stop fastapi-app || true
            sudo docker rm fastapi-app || true
            echo "ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ..."
            sudo docker build -t my-fastapi-app .
            echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰(í¬íŠ¸ 8000, localhostë§Œ ì ‘ê·¼ ê°€ëŠ¥)..."
            sudo docker run -d --name fastapi-app -p 127.0.0.1:8000:8000 --env MONGO_URI="${{ secrets.MONGO_URI }}" my-fastapi-app
            echo "==== ë°°í¬ ì™„ë£Œ ===="
          '

      - name: 10. Test Application Deployment
        run: |
          echo "==== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ í…ŒìŠ¤íŠ¸ ===="
          # ìž ì‹œ ëŒ€ê¸° (ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ì‹œê°„)
          sleep 10
          
          # ë¡œì»¬ì—ì„œ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=10 gwinvade99@34.47.103.49 '
            echo "FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸..."
            curl -f http://localhost:8000/ || echo "FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            echo "Swagger ë¬¸ì„œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸..."
            curl -f http://localhost:8000/docs || echo "Swagger ë¬¸ì„œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          '
          
          echo "ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì† URL:"
          echo "ðŸŒ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜: https://study-mate.club"
          echo "ðŸ“š Swagger ë¬¸ì„œ: https://study-mate.club/docs"
          echo "ðŸ”§ API ë¬¸ì„œ: https://study-mate.club/redoc"

      - name: 11. Show Docker Container Logs (On Failure)
        if: failure()
        run: |
          echo "==== FastAPI ë„ì»¤ ì»¨í…Œì´ë„ˆ ë¡œê·¸ ì¶œë ¥ (ë°°í¬ ì‹¤íŒ¨ì‹œ) ===="
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=10 gwinvade99@34.47.103.49 '
            sudo docker logs fastapi-app || echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          '
