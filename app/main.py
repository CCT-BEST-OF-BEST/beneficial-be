import logging
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from app.api.chat.chat_router import router as chat_router
from app.api.system.indexing import router as indexing_router
from app.api.learning.learning_router import router as learning_router
from app.api.learning.stage3_router import router as stage3_router
from app.common.init.initialization import get_initialization_service

# ì „ì—­ ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s"
)

logger = logging.getLogger(__name__)

app = FastAPI(
    title="ğŸ“ CCT ë°±ì—”ë“œ API",
    version="1.0.0",
    description="""
# ì´ˆë“±í•™ìƒ ëŒë´„ë°˜ í•œêµ­ì–´ êµìœ¡ ì‹œìŠ¤í…œ

## ì‹œìŠ¤í…œ ê°œìš”
ì´ˆë“±í•™ìƒ ëŒë´„ë°˜ í•™ìƒë“¤ì„ ìœ„í•œ í•œêµ­ì–´ ë§ì¶¤ë²• êµìœ¡ì„ ìœ„í•œ AI ê¸°ë°˜ í•™ìŠµ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥
- **ë‹¨ê³„ë³„ í•™ìŠµ**: 1ë‹¨ê³„(ì¹´ë“œ í•™ìŠµ) â†’ 2ë‹¨ê³„(ë“œë˜ê·¸&ë“œë¡­) â†’ 3ë‹¨ê³„(ë¬¸ì œí’€ì´)
- **AI í•™ìŠµ ë„ìš°ë¯¸**: RAG ê¸°ë°˜ ë§ì¶¤ë²• ì§ˆì˜ì‘ë‹µ ì‹œìŠ¤í…œ
- **ê°œì¸í™” í•™ìŠµ**: í•™ìƒë³„ ì§„í–‰ë„ ì¶”ì  ë° ë³µìŠµ ì‹œìŠ¤í…œ
- **ì ì‘í˜• ë³µìŠµ**: í‹€ë¦° ë¬¸ì œ ìë™ ë³µìŠµ ë° ë±ƒì§€ ì‹œìŠ¤í…œ

## ë¹ ë¥¸ ì‹œì‘
1. **í•™ìŠµ ì‹œì‘**: `/learning/stage1/cards` - ì¹´ë“œ í•™ìŠµ
2. **ë¬¸ì œ í’€ì´**: `/learning/stage3/next-problem` - 3ë‹¨ê³„ ë¬¸ì œ
3. **AI ë„ì›€**: `/chat/` - ë§ì¶¤ë²• ì§ˆë¬¸í•˜ê¸°
    """,
    openapi_tags=[
        {
            "name": "chat",
            "description": """
## AI í•™ìŠµ ë„ìš°ë¯¸ ì±„íŒ… API

### ì£¼ìš” ê¸°ëŠ¥
- **RAG ê¸°ë°˜ ë‹µë³€**: í•œêµ­ì–´ ë¬¸ë²•/ë§ì¶¤ë²• ì •í™•í•œ ë‹µë³€
- **ì´ˆë“±í•™ìƒ ë§ì¶¤**: ì‰¬ìš´ ì–¸ì–´ë¡œ ì„¤ëª…í•˜ëŠ” AI
- **ì‹¤ì‹œê°„ ëŒ€í™”**: í•™ìŠµ ì¤‘ ê¶ê¸ˆí•œ ì  ì¦‰ì‹œ í•´ê²°

### ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤
- ë¬¸ì œ í’€ì´ ì¤‘ í—·ê°ˆë¦¬ëŠ” ë§ì¶¤ë²• ì§ˆë¬¸
- í•œêµ­ì–´ ë¬¸ë²• ê°œë… ì„¤ëª… ìš”ì²­
- í•™ìŠµ ë°©ë²•ì´ë‚˜ íŒ ë¬¸ì˜
            """
        },
        {
            "name": "learning",
            "description": """
## ë‹¨ê³„ë³„ í•™ìŠµ API

### ì£¼ìš” ê¸°ëŠ¥
- **1ë‹¨ê³„ ì¹´ë“œ í•™ìŠµ**: ì–´íœ˜ ì¹´ë“œ í”Œë¦½ í•™ìŠµ
- **2ë‹¨ê³„ ë“œë˜ê·¸&ë“œë¡­**: ì¸í„°ë™í‹°ë¸Œ ë¬¸ì œ í’€ì´
- **ì´ë¯¸ì§€ ì„œë¹™**: í•™ìŠµìš© ì´ë¯¸ì§€ íŒŒì¼ ì œê³µ

### ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤
- ë‹¨ê³„ë³„ ìˆœì°¨ í•™ìŠµ ì§„í–‰
- ì¹´ë“œ í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ êµ¬í˜„
- ë“œë˜ê·¸&ë“œë¡­ ì¸í„°ë™ì…˜ ì²˜ë¦¬
            """
        },
        {
            "name": "stage3",
            "description": """
## 3ë‹¨ê³„ ë¬¸ì œí’€ì´ API

### ì£¼ìš” ê¸°ëŠ¥
- **ìˆœì°¨ í•™ìŠµ**: 1-5ë²ˆ ë¬¸ì œ ìˆœì„œëŒ€ë¡œ ì¶œì œ
- **ì ì‘í˜• ë³µìŠµ**: í‹€ë¦° ë¬¸ì œë§Œ ìë™ ë³µìŠµ
- **ë±ƒì§€ ì‹œìŠ¤í…œ**: í•™ìŠµ ë™ê¸°ë¶€ì—¬ë¥¼ ìœ„í•œ ë±ƒì§€
- **ì§„í–‰ë„ ê´€ë¦¬**: ê°œì¸ë³„ í•™ìŠµ ìƒíƒœ ì¶”ì 
- **í•´ë‹¹ API ë¥¼ ë”°ë¡œ ë¶„ë¦¬í•œ ì´ìœ ëŠ” ì„œë¹„ìŠ¤ ë¡œì§ì˜ ë³µì¡ë„ ë•Œë¬¸ì— learning ê´€ë ¨ API ì—ì„œ ë¶„ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.**

### í•™ìŠµ ì•Œê³ ë¦¬ì¦˜
1. **1ë‹¨ê³„**: ëª¨ë“  ë¬¸ì œ ìˆœì°¨ í•™ìŠµ (1â†’2â†’3â†’4â†’5) : ì •ë‹µ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ 5ë¬¸ì œë¥¼ ë¨¼ì € í’€ê³ 
2. **2ë‹¨ê³„**: í‹€ë¦° ë¬¸ì œë§Œ ë³µìŠµ (ìˆœí™˜ ë°©ì‹) : í‹€ë¦° ë¬¸ì œë“¤ë§Œ ë°˜ë³µì ìœ¼ë¡œ ì¶œì œ
3. **ì™„ë£Œ**: ëª¨ë“  ë¬¸ì œ ì •ë‹µ ì‹œ í•™ìŠµ ì™„ë£Œ
4. **ë³µìŠµ**: í‹€ë¦° ë¬¸ì œëŠ” ê³„ì† ë³µìŠµ, ë§ì¶˜ ë¬¸ì œëŠ” ì œì™¸
5. **ì˜ˆì‹œ**: 1 ë²ˆë¬¸ì œ : ì •ë‹µ(ì²«í•™ìŠµ -> í›Œë¥­í•´ìš”) -> 2ë²ˆ ë¬¸ì œ : ì˜¤ë‹µ(ì²«í•™ìŠµ -> ì ì‹œí›„ë³µìŠµ) -> 3ë²ˆ ë¬¸ì œ : ì •ë‹µ (ì²«í•›ìŠµ -> í›Œë¥­í•´ìš”) -> 
4ë²ˆ ë¬¸ì œ : ì˜¤ë‹µ (ì²«í•™ìŠµ -> ì ì‹œ í›„ ë³µìŠµ) -> 5ë²ˆ ë¬¸ì œ : ì •ë‹µ (ì²«í•™ìŠµ -> í›Œë¥­í•´ìš”) -> ë‹¤ì‹œ 2ë²ˆ ë¬¸ì œ : ì˜¤ë‹µ (ì¬ë„ì „ -> ì¬ë„ì „) -> ë‹¤ì‹œ 4ë²ˆ ë¬¸ì œ : ì •ë‹µ (ì¬ë„ì „ -> í›Œë¥­í•´ìš”) -> ë˜ ë‹¤ì‹œ 2ë²ˆ ë¬¸ì œ : ì •ë‹µ (ì¬ë„ì „ -> í˜ë¥­í•´ìš”)
            """
        },
        {
            "name": "admin",
            "description": """
## ì‹œìŠ¤í…œ ê´€ë¦¬ API

### ì£¼ìš” ê¸°ëŠ¥
- **ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§**: ë°±ì—”ë“œ ìƒíƒœ ë° ì„±ëŠ¥ í™•ì¸
- **ë°ì´í„° ê´€ë¦¬**: í•™ìŠµ ë°ì´í„° ë° ë²¡í„° DB ê´€ë¦¬
- **ì¸ë±ì‹±**: PDF ë¬¸ì„œ ì²˜ë¦¬ ë° ê²€ìƒ‰ ì¸ë±ìŠ¤ ìƒì„±

### ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤
- ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§
- ë°ì´í„°ë² ì´ìŠ¤ ë¬¸ì„œ ìˆ˜ í™•ì¸
- ìƒˆë¡œìš´ í•™ìŠµ ìë£Œ ì¶”ê°€
            """
        },
    ]
)

# CORS ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",  # React ê°œë°œ ì„œë²„
        "http://localhost:5173",  # Vite ê°œë°œ ì„œë²„
        "http://localhost:8080",  # Vue ê°œë°œ ì„œë²„
        "http://127.0.0.1:3000",
        "http://127.0.0.1:5173",
        "http://127.0.0.1:8080",
        "*"  # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ëª¨ë“  origin í—ˆìš© (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œê±°)
    ],
    allow_credentials=True,
    allow_methods=["*"],  # ëª¨ë“  HTTP ë©”ì„œë“œ í—ˆìš©
    allow_headers=["*"],  # ëª¨ë“  í—¤ë” í—ˆìš©
)

# Static íŒŒì¼ ë§ˆìš´íŠ¸ (ì´ë¯¸ì§€ íŒŒì¼ ì„œë¹™ì„ ìœ„í•´)
app.mount("/images", StaticFiles(directory="app/static/images"), name="images")


@app.on_event("startup")
async def startup_event():
    """ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ì‹¤í–‰ë  ì´ë²¤íŠ¸"""
    try:
        # ì´ˆê¸°í™” ì„œë¹„ìŠ¤ë¥¼ í†µí•œ ê°„ë‹¨í•œ ì´ˆê¸°í™”
        init_service = get_initialization_service()
        result = await init_service.initialize_application()

        if result["status"] == "success":
            logger.info("ğŸ‰ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì™„ë£Œ!")
        else:
            logger.warning(f"âš ï¸ ì´ˆê¸°í™” ê²½ê³ : {result['message']}")

    except Exception as e:
        logger.error(f"âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨: {e}")


@app.on_event("shutdown")
async def shutdown_event():
    """ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ì‹¤í–‰ë  ì´ë²¤íŠ¸"""
    logger.info("ğŸ›‘ Beneficial RAG System ì¢…ë£Œ ì¤‘...")


# ë¼ìš°í„° ë“±ë¡
app.include_router(chat_router)
app.include_router(learning_router)
app.include_router(stage3_router)
app.include_router(indexing_router)


@app.get(
    "/",
    summary="ì‹œìŠ¤í…œ ê¸°ë³¸ ì •ë³´",
    description="""
## API ì„¤ëª…
CCT ë°±ì—”ë“œ APIì˜ ê¸°ë³¸ ì •ë³´ì™€ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

## í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ ê°€ì´ë“œ
- **ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸**: ì•± ì‹œì‘ ì‹œ ì—°ê²° ìƒíƒœ ì ê²€
- **ë²„ì „ ì •ë³´**: API ë²„ì „ ë° ì‹œìŠ¤í…œ ì •ë³´ í‘œì‹œ

## ì‘ë‹µ ì˜ˆì‹œ
```json
{
  "message": "CCT ë°±ì—”ë“œ API",
  "version": "1.0.0",
  "description": "ì´ˆë“±í•™ìƒ ëŒë´„ë°˜ í•™ìƒë“¤ì„ ìœ„í•œ í•œêµ­ì–´ êµìœ¡ì„ ìœ„í•œ ì‹œìŠ¤í…œ"
}
```
    """
)
def read_root():
    """ì‹œìŠ¤í…œ ê¸°ë³¸ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    return {
        "message": "CCT ë°±ì—”ë“œ API",
        "version": "1.0.0",
        "description": "ì´ˆë“±í•™ìƒ ëŒë´„ë°˜ í•™ìƒë“¤ì„ ìœ„í•œ í•œêµ­ì–´ êµìœ¡ì„ ìœ„í•œ ì‹œìŠ¤í…œ"
    }

